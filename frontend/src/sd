import React, { useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';

import Header from './components/Header';
import Sidebar from './components/Sidebar';
import HomePage from './pages/HomePage';
import LoginPage from './pages/LoginPage';
import CreateAccountPage from './pages/CreateAccountPage';
import SavedPage from './pages/SavedPage'; 
import SearchResultsPage from './pages/SearchResultsPage'; 
import ProfilePage from './pages/ProfilePage'; 
import DocumentsPage from './pages/DocumentsPage'; 
import ServicesPage from './pages/ServicesPage'; 
import HotlinesPage from './pages/HotlinesPage';
import FindJobsPage from './pages/FindJobsPage'; 
import AboutPage from './pages/AboutPage'; 
import ContactPage from './pages/ContactPage'; 
import AdminUsersPage from './admin/AdminUsersPage';

// --- IMPORTS FOR ADMIN ---
import AdminLayout from './admin/AdminLayout';
import AdminLoginPage from './admin/AdminLoginPage';
import AdminDashboardPage from './admin/AdminDashboardPage';
import AdminOfficialsPage from './admin/AdminOfficialsPage'; 
// -------------------------

// --- Placeholder Component for missing pages ---
const Placeholder = ({ title }) => (
    <div style={{ paddingTop: '80px', paddingLeft: '290px', padding: '100px 30px', minHeight: '100vh', backgroundColor: '#f8f8f8' }}>
        <h1 style={{ color: '#2563eb' }}>{title} Page</h1>
        <p>This is a placeholder for the <strong>{title}</strong> content.</p>
    </div>
);
// ---------------------------------------------


const App = () => {
    // STATE: Stores the complete fetched user object { id, name, email, profilePictureUrl, ... }
    const [currentUser, setCurrentUser] = useState(null); 
    
    // STATE: Admin login state
    const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(() => sessionStorage.getItem("isAdminLoggedIn") === "true");

    // DERIVED STATE: True if a user object exists
    const isLoggedIn = !!currentUser; 

    /**
     * Fetches the user profile data from the backend using the stored email.
     * This is the function that ensures the Header gets the picture URL.
     */
    const fetchUserProfile = async (email) => {
        if (!email) return;

        try {
            const response = await fetch(`http://localhost:5000/api/user/profile/${email}`);
            
            if (!response.ok) {
                console.error("Failed to fetch user profile:", response.status);
                handleLogout(false); // Log out locally but don't clear email if it's a transient error
                return;
            }
            
            const profileData = await response.json();
            // Update the state with the full profile object
            setCurrentUser(profileData); 
        } catch (error) {
            console.error("Network or parsing error fetching profile:", error);
            handleLogout(false);
        }
    };

    /**
     * Handles successful user login. Stores the email and triggers the profile fetch.
     */
    const handleLoginSuccess = (user) => {
        // We expect the login response to include at least the user's email
        localStorage.setItem("userEmail", user.email);
        fetchUserProfile(user.email);
    };

    /**
     * Handles user logout. Clears user state and optionally localStorage.
     */
    const handleLogout = (clearLocalStorage = true) => {
        setCurrentUser(null);
        if (clearLocalStorage) {
            localStorage.removeItem("userEmail");
        }
        sessionStorage.removeItem("isAdminLoggedIn");
        setIsAdminLoggedIn(false);
    };
    
    /**
     * Handles admin login success.
     */
    const handleAdminLoginSuccess = () => {
        sessionStorage.setItem("isAdminLoggedIn", 'true');
        setIsAdminLoggedIn(true);
    };

    /**
     * Handles admin logout.
     */
    const handleAdminLogout = () => {
        setIsAdminLoggedIn(false);
        sessionStorage.removeItem("isAdminLoggedIn");
    };
    
    /**
     * Updates local user state after a successful profile edit (e.g., changing picture).
     */
    const handleUpdateUser = ({ name, profilePictureUrl }) => {
        setCurrentUser(prevUser => ({
            ...prevUser,
            name: name !== undefined ? name : prevUser.name,
            profilePictureUrl: profilePictureUrl !== undefined ? profilePictureUrl : prevUser.profilePictureUrl,
        }));
    };
    
    /**
     * Effect hook to check for a previously logged-in user on component mount.
     */
    useEffect(() => {
        const storedUserEmail = localStorage.getItem("userEmail");
        const storedAdminLogin = sessionStorage.getItem("isAdminLoggedIn") === "true";

        if (storedUserEmail) {
            fetchUserProfile(storedUserEmail); // Fetch full profile using stored email
        }
        
        if (storedAdminLogin) {
            setIsAdminLoggedIn(true);
        }
    }, []);

    // State for triggering refetches in sidebar/header (e.g., after a new post)
    const [refetchTrigger, setRefetchTrigger] = useState(0);


    // --- Application Layout for Authenticated Users ---
    const AppLayout = () => (
        <>
            {/* PASSING THE FULL currentUser OBJECT to Header */}
            <Header 
                currentUser={currentUser} 
                onLogout={handleLogout} 
            />
            
            <Sidebar refetchTrigger={refetchTrigger} /> 
            
            <div style={appStyles.contentArea}>
                <Routes>
                    {/* Use optional chaining (currentUser?.) to safely access properties */}
                    <Route 
                        path="/home" 
                        element={
                            <HomePage 
                                userName={currentUser?.name} 
                                userEmail={currentUser?.email} 
                                profilePictureUrl={currentUser?.profilePictureUrl} 
                                setRefetchTrigger={setRefetchTrigger}
                            />
                        } 
                    />
                    
                    <Route 
                        path="/saved" 
                        element={<SavedPage 
                            userName={currentUser?.name} 
                            userEmail={currentUser?.email} 
                            profilePictureUrl={currentUser?.profilePictureUrl} 
                        />} 
                    />
                    <Route path="/search" element={<SearchResultsPage userName={currentUser?.name} userEmail={currentUser?.email} profilePictureUrl={currentUser?.profilePictureUrl}/>} />

                    <Route 
                        path="/profile" 
                        element={<ProfilePage 
                            userId={currentUser?.id} 
                            userName={currentUser?.name} 
                            userEmail={currentUser?.email}
                            onUpdateUser={handleUpdateUser} 
                            profilePictureUrl={currentUser?.profilePictureUrl}
                        />} 
                    />

                    <Route 
                        path="/documents" 
                        element={<DocumentsPage 
                            userName={currentUser?.name} 
                            userEmail={currentUser?.email} 
                            profilePictureUrl={currentUser?.profilePictureUrl}
                        />} 
                    />
                    
                    {/* Placeholder and other static routes */}
                    <Route path="/announcements" element={<Placeholder title="Announcements" />} />
                    <Route path="/services" element={<ServicesPage userName={currentUser?.name} userEmail={currentUser?.email} profilePictureUrl={currentUser?.profilePictureUrl} />} />
                    
                    <Route 
                        path="/about" 
                        element={<AboutPage userName={currentUser?.name} userEmail={currentUser?.email} profilePictureUrl={currentUser?.profilePictureUrl} />} 
                    />
                    
                    <Route 
                        path="/hotlines" 
                        element={<HotlinesPage userName={currentUser?.name} userEmail={currentUser?.email} profilePictureUrl={currentUser?.profilePictureUrl} />} 
                    />
                    
                    <Route 
                        path="/contact" 
                        element={<ContactPage userName={currentUser?.name} userEmail={currentUser?.email} profilePictureUrl={currentUser?.profilePictureUrl} />} 
                    />
                    
                    <Route 
                        path="/find-jobs" 
                        element={<FindJobsPage userName={currentUser?.name} userEmail={currentUser?.email} profilePictureUrl={currentUser?.profilePictureUrl} />} 
                    />
                    
                    {/* Default Route */}
                    <Route path="/*" element={<Navigate to="/login" replace />} />
                </Routes>
            </div>
        </>
    );

    // --- Admin Routes Layout ---
    const AdminRoutes = () => (
        <AdminLayout onLogout={handleAdminLogout}>
            <Routes>
                <Route path="/dashboard" element={<AdminDashboardPage />} />
                <Route path="/users" element={<AdminUsersPage />} />
                <Route path="/officials" element={<AdminOfficialsPage />} /> 
                <Route path="/posts" element={<Placeholder title="Admin Content Posts" />} />
                <Route path="/jobs" element={<Placeholder title="Admin Job Listings" />} />
                <Route path="/news" element={<Placeholder title="Admin News Management" />} />
                <Route path="/announcements" element={<Placeholder title="Admin Announcements" />} />
                <Route path="/documents" element={<Placeholder title="Admin Documents Requests" />} />
                <Route path="/services" element={<Placeholder title="Admin Services Management" />} />
                <Route path="/hotlines" element={<Placeholder title="Admin Hotlines Management" />} />
                <Route path="/contacts" element={<Placeholder title="Admin Contacts Management" />} />
                
                {/* Default Admin Route */}
                <Route path="/" element={<Navigate to="/admin/dashboard" replace />} />
            </Routes>
        </AdminLayout>
    );

    return (
        <Router>
            <Routes>
                {/* User Authentication Routes */}
                <Route path="/login" element={<LoginPage onLoginSuccess={handleLoginSuccess} />} />
                <Route path="/signup" element={<CreateAccountPage />} />
                
                {/* Protected User Routes: Redirects to /login if not logged in */}
                <Route path="/*" element={isLoggedIn ? <AppLayout /> : <Navigate to="/login" replace />} />
                
                {/* Admin Authentication and Protected Routes */}
                <Route 
                    path="/admin" 
                    element={isAdminLoggedIn ? <Navigate to="/admin/dashboard" replace /> : <AdminLoginPage onAdminLoginSuccess={handleAdminLoginSuccess} />} 
                />
                <Route 
                    path="/admin/*" 
                    element={isAdminLoggedIn ? <AdminRoutes /> : <Navigate to="/admin" replace />} 
                />
            </Routes>
        </Router>
    );
};

const appStyles = {
    contentArea: { 
        paddingTop: '60px', 
        marginLeft: '290px', // Standard offset for the Sidebar
        paddingRight: '20px', 
        minHeight: '100vh' 
    }
};

export default App;